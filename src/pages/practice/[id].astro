---
import { getLocale } from 'astro-i18n-aut';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { type Language, getRelativeLocaleUrl } from '@/shared';
import { createSSGTranslations } from '@/i18n/utils';
import PracticeControls from '@/components/practice/PracticeControls';
import { practiceLoader } from '@/data/practices/PracticeLoader';

const lang = getLocale(Astro.url) as Language;
const t = createSSGTranslations(lang, 'practice');
const { id } = Astro.params;

if (!id) {
  return Astro.redirect(`/${lang}/practice/`);
}

// Áõ¥Êé•‰ΩøÁî®Êï∞ÊçÆÂä†ËΩΩÂô®ÔºåÊó†ÈúÄÂ§çÊùÇËΩ¨Êç¢
const practice = practiceLoader.getSimplePractice(id, lang);

if (!practice) {
  return Astro.redirect(`/${lang}/practice/`);
}

// Define static paths for practice pages
export async function getStaticPaths() {
  const practices = practiceLoader.getPractices();
  const languages = ['en', 'zh', 'es', 'ar', 'hi', 'ja', 'ko'];
  
  return practices.flatMap(practice => 
    languages.map(lang => ({
      params: { id: practice.id },
      props: { lang, practice }
    }))
  );
}
---

<BaseLayout
  title={practice.name}
  description={practice.description}
  lang={lang}
>
  <div class="container mx-auto px-4 py-8">
    <!-- Back Button -->
    <div class="mb-6">
      <a
        href={getRelativeLocaleUrl(lang, '/practice/')}
        class="btn btn-ghost btn-sm"
      >
        ‚Üê {t('backToPractice')}
      </a>
    </div>

    <!-- Practice Header -->
    <div class="text-center mb-8">
      <div class="flex items-center justify-center gap-2 mb-4">
        <span class="badge badge-primary badge-lg">{practice.difficulty}</span>
        <span class="badge badge-outline badge-lg">{practice.category}</span>
        <span class="text-sm text-base-content/60">{practice.defaultDuration} {t('minutes')}</span>
      </div>
      
      <h1 class="text-4xl md:text-5xl font-bold text-base-content mb-4">
        {practice.name}
      </h1>
      
      <p class="text-xl text-base-content/70 max-w-3xl mx-auto mb-6">
        {practice.description}
      </p>

      <!-- Quick Stats -->
      <div class="flex justify-center gap-6 text-sm text-base-content/60">
        <div class="flex items-center gap-1">
          <span>‚≠ê</span>
          <span>{practice.averageRating}</span>
        </div>
        <div class="flex items-center gap-1">
          <span>üìä</span>
          <span>{Math.round(practice.completionRate * 100)}% {t('completionRate')}</span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left Column: Practice Info & Steps -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Quick Info -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-2xl mb-4">{t('quickInfo')}</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h3 class="font-semibold text-base-content mb-2">{t('duration')}</h3>
                <p class="text-base-content/70">{practice.minDuration}-{practice.maxDuration} {t('minutes')}</p>
              </div>
              
              <div>
                <h3 class="font-semibold text-base-content mb-2">{t('difficulty')}</h3>
                <p class="text-base-content/70 capitalize">{practice.difficulty}</p>
              </div>
              
              <div>
                <h3 class="font-semibold text-base-content mb-2">{t('category')}</h3>
                <p class="text-base-content/70 capitalize">{practice.category}</p>
              </div>
              
              <div>
                <h3 class="font-semibold text-base-content mb-2">{t('targetAudience')}</h3>
                <p class="text-base-content/70">{practice.targetAudience.join(', ')}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Practice Steps -->
        <div class="card bg-base-100 shadow-xl">
          <div class="card-body">
            <h2 class="card-title text-2xl mb-4">{t('practiceSteps')}</h2>
            
            <div class="space-y-4">
              {practice.steps.map((step, index) => (
                <div class="flex gap-4 p-4 bg-base-200 rounded-lg">
                  <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-primary text-primary-content rounded-full flex items-center justify-center font-bold">
                      {index + 1}
                    </div>
                  </div>
                  <div class="flex-grow">
                    <h3 class="font-semibold text-lg mb-2">{step.title}</h3>
                    <p class="text-base-content/70 mb-2">{step.description}</p>
                    <p class="text-sm text-base-content/60">{step.instruction}</p>
                    <div class="mt-2 text-xs text-base-content/50">
                      {Math.floor(step.duration / 60)}:{(step.duration % 60).toString().padStart(2, '0')} {t('duration')}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>

        <!-- Benefits & Tips -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Benefits -->
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <h2 class="card-title text-xl mb-4">{t('benefits')}</h2>
              <ul class="space-y-2">
                {practice.benefits.map((benefit, index) => (
                  <li class="flex items-start gap-2">
                    <span class="text-green-500 mt-1">‚úì</span>
                    <span class="text-base-content/70">{benefit}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- Tips -->
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
              <h2 class="card-title text-xl mb-4">{t('tips')}</h2>
              <ul class="space-y-2">
                {practice.tips.map((tip, index) => (
                  <li class="flex items-start gap-2">
                    <span class="text-blue-500 mt-1">üí°</span>
                    <span class="text-base-content/70">{tip}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column: Controls Only -->
      <div class="space-y-6">
        <div class="sticky top-20">
          <PracticeControls 
            defaultDuration={practice.defaultDuration}
            minDuration={practice.minDuration}
            maxDuration={practice.maxDuration}
            translations={{
              start: t('startPractice'),
              pause: t('pause'),
              resume: t('resume'),
              reset: t('reset'),
              mute: t('mute'),
              unmute: t('unmute'),
              settings: t('settings'),
              duration: t('duration'),
              completed: t('practiceCompleted'),
              practiceSettings: t('practiceSettings'),
              minutes: t('minutes'),
              durationChangeTitle: t('durationChangeTitle'),
              durationChangeMessage: t('durationChangeMessage'),
              durationChangeCancel: t('durationChangeCancel'),
              durationChangeConfirm: t('durationChangeConfirm')
            }}
            client:load 
          />
        </div>
      </div>
    </div>

    <!-- Tags -->
    <div class="mt-8 text-center">
      <div class="flex flex-wrap justify-center gap-2">
        {practice.tags.map((tag) => (
          <span class="badge badge-outline badge-sm">{tag}</span>
        ))}
      </div>
    </div>
  </div>
</BaseLayout>