---
import { getLocale } from 'astro-i18n-aut';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { type Language, getRelativeLocaleUrl } from '@/shared';
import { createSSGTranslations } from '@/i18n/utils';
import { getEntry } from 'astro:content';
import Icon from '@/components/Icon';

const lang = getLocale(Astro.url) as Language;

const t = createSSGTranslations(lang, 'resources');

// Load crisis hotlines data
const crisisData = await getEntry('resources', 'crisis');
const crisis = crisisData?.data[lang] || crisisData?.data.en;

// Get unique regions for filter
let regions = crisis?.regions || [];

// Language to country code mapping for sorting
const languageCountryMap: Record<Language, string[]> = {
  en: ['US', 'GB', 'CA', 'AU', 'NZ', 'IE', 'SG', 'HK'],
  zh: ['CN', 'TW', 'HK', 'SG'],
  es: ['ES', 'MX', 'AR', 'CO', 'CL', 'PE'],
  ja: ['JP'],
  ko: ['KR'],
  hi: ['IN'],
  ar: ['SA', 'AE', 'EG', 'JO'],
};

// Sort regions: prioritize countries matching current language
const prioritizedRegions = [...regions].sort((a, b) => {
  const aPriority = languageCountryMap[lang]?.includes(a.code) ? 0 : 1;
  const bPriority = languageCountryMap[lang]?.includes(b.code) ? 0 : 1;
  if (aPriority !== bPriority) return aPriority - bPriority;
  return a.name.localeCompare(b.name);
});

regions = prioritizedRegions;

const uniqueRegions = regions.map((r) => ({
  code: r.code,
  name: r.name,
}));

// Country emoji mapping
const countryEmojis: Record<string, string> = {
  US: 'ğŸ‡ºğŸ‡¸',
  CN: 'ğŸ‡¨ğŸ‡³',
  GB: 'ğŸ‡¬ğŸ‡§',
  CA: 'ğŸ‡¨ğŸ‡¦',
  AU: 'ğŸ‡¦ğŸ‡º',
  NZ: 'ğŸ‡³ğŸ‡¿',
  JP: 'ğŸ‡¯ğŸ‡µ',
  KR: 'ğŸ‡°ğŸ‡·',
  IN: 'ğŸ‡®ğŸ‡³',
  ES: 'ğŸ‡ªğŸ‡¸',
  SA: 'ğŸ‡¸ğŸ‡¦',
  MX: 'ğŸ‡²ğŸ‡½',
  BR: 'ğŸ‡§ğŸ‡·',
  FR: 'ğŸ‡«ğŸ‡·',
  DE: 'ğŸ‡©ğŸ‡ª',
  IT: 'ğŸ‡®ğŸ‡¹',
  SG: 'ğŸ‡¸ğŸ‡¬',
  TW: 'ğŸ‡¹ğŸ‡¼',
  HK: 'ğŸ‡­ğŸ‡°',
  NL: 'ğŸ‡³ğŸ‡±',
  SE: 'ğŸ‡¸ğŸ‡ª',
  NO: 'ğŸ‡³ğŸ‡´',
  DK: 'ğŸ‡©ğŸ‡°',
  FI: 'ğŸ‡«ğŸ‡®',
  CH: 'ğŸ‡¨ğŸ‡­',
  AT: 'ğŸ‡¦ğŸ‡¹',
  BE: 'ğŸ‡§ğŸ‡ª',
  PT: 'ğŸ‡µğŸ‡¹',
  GR: 'ğŸ‡¬ğŸ‡·',
  PL: 'ğŸ‡µğŸ‡±',
  IE: 'ğŸ‡®ğŸ‡ª',
  AR: 'ğŸ‡¦ğŸ‡·',
  CO: 'ğŸ‡¨ğŸ‡´',
  CL: 'ğŸ‡¨ğŸ‡±',
  PE: 'ğŸ‡µğŸ‡ª',
  AE: 'ğŸ‡¦ğŸ‡ª',
  EG: 'ğŸ‡ªğŸ‡¬',
  JO: 'ğŸ‡¯ğŸ‡´',
};
---

<BaseLayout
  title={t('crisis.title')}
  description={t('crisis.description')}
  lang={lang}
>
  <main
    class="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 dark:from-gray-900 dark:to-gray-800 py-12"
  >
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="mb-8">
        <ol
          class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400"
        >
          <li>
            <a
              href={getRelativeLocaleUrl(lang)}
              class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            >
              {t('page.title')}
            </a>
          </li>
          <li class="flex items-center">
            <Icon name="chevron-right" class="w-4 h-4" size={16} client:load />
          </li>
          <li class="text-gray-900 dark:text-white font-medium">
            {t('crisis.title')}
          </li>
        </ol>
      </nav>

      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
          {t('crisis.title')}
        </h1>
        <p class="text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto mb-3">
          {t('crisis.subtitle')}
        </p>
        <p class="text-lg text-gray-500 dark:text-gray-400 max-w-3xl mx-auto mb-3">
          {t('crisis.description')}
        </p>
        <p class="text-base text-gray-600 dark:text-gray-400 max-w-3xl mx-auto leading-relaxed">
          <span class="font-semibold text-gray-800 dark:text-gray-200">{t('crisis.encouragement.title')}.</span>{' '}
          {t('crisis.encouragement.message')}
        </p>
      </div>

      <!-- Emergency Alert -->
      <div
        class="bg-red-100 dark:bg-red-900/30 border-l-4 border-red-500 dark:border-red-400 p-6 mb-8 rounded-lg"
      >
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <Icon name="alert-triangle" class="h-5 w-5 text-red-600 dark:text-red-400" size={20} client:load />
          </div>
          <div>
            <h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">
              {t('crisis.emergency.title')}
            </h3>
            <p class="text-red-700 dark:text-red-300">
              {t('crisis.emergency.description')}
            </p>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div
        class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700"
      >
        <div
          class="flex flex-col md:flex-row gap-4 items-center justify-between"
        >
          <div class="flex-1 max-w-md w-full">
            <input
              type="text"
              id="searchInput"
              placeholder={t('crisis.filters.searchPlaceholder')}
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400"
            />
          </div>
          <div class="w-full md:w-auto">
            <select
              id="regionFilter"
              class="w-full md:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
            >
              <option value="all">ğŸŒ {t('crisis.filters.allRegions')}</option>
              {uniqueRegions.map((region) => (
                <option value={region.code}>
                  {countryEmojis[region.code] || 'ğŸŒ'} {region.name}
                </option>
              ))}
            </select>
          </div>
        </div>
      </div>

      <!-- Hotlines Grid -->
      <div id="hotlinesContainer" class="space-y-8">
        {regions.map((region) => (
          <div
            class="region-section"
            data-region={region.code}
            data-region-name={region.name.toLowerCase()}
          >
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
              <span class="text-2xl">{countryEmojis[region.code] || 'ğŸŒ'}</span>
              <span>{region.name}</span>
              {region.countryCode && (
                <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                  ({region.countryCode})
                </span>
              )}
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {region.hotlines.map((hotline) => (
                <div
                  class="hotline-card bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow border border-gray-200 dark:border-gray-700 overflow-hidden"
                  data-hotline-name={hotline.name.toLowerCase()}
                  data-hotline-phone={hotline.phone.toLowerCase()}
                >
                  <div class="p-6">
                    <div class="flex items-center mb-3 gap-2">
                      <Icon name="phone" class="w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0" size={20} client:load />
                      <span class="text-sm font-medium text-red-600 dark:text-red-400">
                        {t('crisis.hotline.phone')}
                      </span>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">
                      {hotline.name}
                    </h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4 line-clamp-3">
                      {hotline.description}
                    </p>

                    <!-- Phone Number -->
                    <div class="mb-3">
                      <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">
                        <span class="font-medium">{t('crisis.hotline.phone')}:</span>
                      </p>
                      {hotline.phone.startsWith('tel:') || hotline.phone.match(/^\d/) ? (
                        <a
                          href={`tel:${region.countryCode ? region.countryCode.replace('+', '') : ''}${hotline.phone.replace(/^tel:/, '').replace(/\s/g, '')}`}
                          class="text-lg font-semibold text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 transition-colors"
                        >
                          {region.countryCode && !hotline.phone.startsWith('tel:') && !hotline.phone.match(/^\+/) ? `${region.countryCode} ` : ''}
                          {hotline.phone.replace(/^tel:/, '')}
                        </a>
                      ) : (
                        <p class="text-lg font-semibold text-gray-700 dark:text-gray-300">
                          {region.countryCode && !hotline.phone.match(/^\+/) ? `${region.countryCode} ` : ''}
                          {hotline.phone}
                        </p>
                      )}
                    </div>

                    <!-- Availability -->
                    <div class="mb-3">
                      <p class="text-sm text-gray-600 dark:text-gray-300">
                        <span class="font-medium">{t('crisis.hotline.available')}:</span>{' '}
                        <span class="text-green-600 dark:text-green-400 font-medium">
                          {hotline.available === '24/7'
                            ? t('crisis.hotline.available247')
                            : hotline.available}
                        </span>
                      </p>
                    </div>

                    <!-- Languages -->
                    {hotline.languages && hotline.languages.length > 0 && (
                      <div class="mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">
                          <span class="font-medium">{t('crisis.hotline.languages')}:</span>
                        </p>
                        <div class="flex flex-wrap gap-2">
                          {hotline.languages.map((language) => (
                            <span
                              class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 text-xs rounded"
                            >
                              {language}
                            </span>
                          ))}
                        </div>
                      </div>
                    )}

                    <!-- Actions -->
                    <div class="flex flex-col gap-2 mt-4">
                      {hotline.phone && (
                        <a
                          href={
                            hotline.phone.startsWith('tel:') ||
                            hotline.phone.match(/^\d/)
                              ? `tel:${hotline.phone.replace(/^tel:/, '').replace(/\s/g, '')}`
                              : `tel:${hotline.phone.replace(/\s/g, '')}`
                          }
                          class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 font-medium"
                        >
                          <Icon name="phone" class="w-4 h-4 flex-shrink-0" size={16} client:load />
                          {t('crisis.hotline.call')}
                        </a>
                      )}
                      {hotline.website && (
                        <a
                          href={hotline.website}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="inline-flex items-center justify-center gap-2 px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200 font-medium"
                        >
                          <Icon name="external-link" class="w-4 h-4 flex-shrink-0" size={16} client:load />
                          {t('crisis.hotline.visitWebsite')}
                        </a>
                      )}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>

      <!-- No Results Message -->
      <div id="noResults" class="hidden text-center py-12">
        <Icon name="search-x" class="mx-auto h-10 w-10 text-gray-400" size={40} client:load />
        <h3 class="mt-4 text-lg font-semibold text-gray-900 dark:text-white">
          {t('crisis.noResults.title')}
        </h3>
        <p class="mt-2 text-gray-500 dark:text-gray-400">
          {t('crisis.noResults.description')}
        </p>
      </div>

      <!-- Disclaimer -->
      <div class="mt-12 bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 dark:border-yellow-500 p-6 rounded-lg">
        <p class="text-sm text-yellow-800 dark:text-yellow-200">
          {t('crisis.disclaimer')}
        </p>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  // Filter functionality
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const regionFilter = document.getElementById('regionFilter') as HTMLSelectElement;
  const hotlinesContainer = document.getElementById('hotlinesContainer');
  const noResults = document.getElementById('noResults');
  const regionSections = document.querySelectorAll('.region-section');

  function filterHotlines() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedRegion = regionFilter.value;
    let visibleCount = 0;

    regionSections.forEach((section) => {
      const regionCode = section.getAttribute('data-region');
      const regionName = section.getAttribute('data-region-name') || '';
      const cards = section.querySelectorAll('.hotline-card');

      // Check if region matches filter
      const regionMatches =
        selectedRegion === 'all' || regionCode === selectedRegion;

      // Check if region name matches search
      const regionNameMatches =
        searchTerm === '' || regionName.includes(searchTerm);

      let hasVisibleCards = false;

      cards.forEach((card) => {
        const hotlineName =
          card.getAttribute('data-hotline-name') || '';
        const hotlinePhone =
          card.getAttribute('data-hotline-phone') || '';

        const matchesSearch =
          searchTerm === '' ||
          hotlineName.includes(searchTerm) ||
          hotlinePhone.includes(searchTerm);

        const shouldShow =
          regionMatches && (regionNameMatches || matchesSearch);

        if (shouldShow) {
          (card as HTMLElement).style.display = 'block';
          hasVisibleCards = true;
          visibleCount++;
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });

      // Show/hide region section based on visible cards
      if (hasVisibleCards && regionMatches) {
        (section as HTMLElement).style.display = 'block';
      } else {
        (section as HTMLElement).style.display = 'none';
      }
    });

    // Show/hide no results message
    if (visibleCount === 0) {
      noResults?.classList.remove('hidden');
      hotlinesContainer?.classList.add('hidden');
    } else {
      noResults?.classList.add('hidden');
      hotlinesContainer?.classList.remove('hidden');
    }
  }

  // Event listeners
  searchInput.addEventListener('input', filterHotlines);
  regionFilter.addEventListener('change', filterHotlines);

  // Initial filter
  filterHotlines();
</script>

<style>
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Card hover effects */
  .hotline-card {
    transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .hotline-card:hover {
    transform: translateY(-2px);
  }

  /* Smooth transitions */
  .region-section {
    transition: opacity 300ms ease-in-out;
  }
</style>

