---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { t, getLocalizedPath, getLanguageFromPath, type Language } from '@/lib/i18n';
import { getCollection } from 'astro:content';
import { localizeQuestionnaire } from '@/lib/questionnaire';
import { Icon } from '@/components/Icon';

const lang = getLanguageFromPath(Astro.url.pathname) as Language;

// Load questionnaires
const questionnairesRaw = await getCollection('questionnaires');
const questionnaires = questionnairesRaw.map(q => localizeQuestionnaire(q.data, lang));
---

<BaseLayout title={t('assessment.title', lang)}>
  <div class="container mx-auto px-4 py-12">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">
        {t('assessment.title', lang)}
      </h1>
      <p class="text-xl text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
        {t('assessment.subtitle', lang)}
      </p>
    </div>

    <!-- Disclaimer -->
    <div class="max-w-3xl mx-auto mb-12 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800/30 rounded-xl p-6">
      <h3 class="flex items-center gap-2 font-semibold text-amber-800 dark:text-amber-300 mb-2">
        <Icon name="AlertTriangle" size={20} client:load />
        {t('assessment.disclaimer.title', lang)}
      </h3>
      <p class="text-amber-700 dark:text-amber-400 text-sm">
        {t('assessment.disclaimer.message', lang)}
      </p>
    </div>

    <!-- Questionnaire Cards -->
    <div class="grid md:grid-cols-2 gap-6 max-w-4xl mx-auto mb-16">
      {questionnaires.map((q) => (
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md hover:shadow-lg transition-shadow border border-gray-100 dark:border-gray-700 overflow-hidden">
          <div class="p-6">
            <div class="flex items-start justify-between mb-4">
              <div>
                <span class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-medium rounded-full mb-2">
                  {q.category}
                </span>
                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                  {q.title}
                </h3>
              </div>
            </div>
            <p class="text-gray-600 dark:text-gray-300 mb-4">
              {q.description}
            </p>
            <div class="flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400 mb-6">
              <span class="flex items-center gap-1">
                <Icon name="Clock" size={14} client:load />
                {q.estimatedMinutes} {t('assessment.minutes', lang)}
              </span>
              <span class="flex items-center gap-1">
                <Icon name="FileText" size={14} client:load />
                {q.questionCount} {t('assessment.questions', lang)}
              </span>
            </div>
            <a
              href={getLocalizedPath(`/assessment/${q.id}/`, lang)}
              class="inline-flex items-center justify-center w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-xl transition-colors"
            >
              {t('assessment.startButton', lang)}
            </a>
          </div>
        </div>
      ))}
    </div>

    <!-- History Section -->
    <div class="max-w-4xl mx-auto">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
        {t('assessment.history.title', lang)}
      </h2>
      <div id="history-container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700 p-6">
        <p id="history-empty" class="text-gray-500 dark:text-gray-400 text-center py-8">
          {t('assessment.history.empty', lang)}
        </p>
        <div id="history-list" class="hidden space-y-4"></div>
        <button
          id="clear-history-btn"
          class="hidden mt-4 text-sm text-red-600 dark:text-red-400 hover:underline"
        >
          {t('assessment.history.clearAll', lang)}
        </button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { getResults, clearAllResults } from '@/lib/storage';
  import type { AssessmentResult } from '@/lib/questionnaire';
  
  const historyEmpty = document.getElementById('history-empty');
  const historyList = document.getElementById('history-list');
  const clearBtn = document.getElementById('clear-history-btn');
  
  function renderHistory() {
    const results = getResults();
    
    if (results.length === 0) {
      historyEmpty?.classList.remove('hidden');
      historyList?.classList.add('hidden');
      clearBtn?.classList.add('hidden');
      return;
    }
    
    historyEmpty?.classList.add('hidden');
    historyList?.classList.remove('hidden');
    clearBtn?.classList.remove('hidden');
    
    if (historyList) {
      historyList.innerHTML = results.slice(0, 10).map((r: AssessmentResult) => `
        <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
          <div>
            <p class="font-medium text-gray-900 dark:text-white">${r.questionnaireTitle}</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">
              ${new Date(r.completedAt).toLocaleDateString()}
            </p>
          </div>
          <div class="text-right">
            <span class="inline-block px-3 py-1 rounded-full text-sm font-medium" style="background-color: ${r.color}20; color: ${r.color}">
              ${r.label}
            </span>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
              Score: ${r.score}
            </p>
          </div>
        </div>
      `).join('');
    }
  }
  
  clearBtn?.addEventListener('click', () => {
    if (confirm('Are you sure you want to clear all history?')) {
      clearAllResults();
      renderHistory();
    }
  });
  
  renderHistory();
</script>

