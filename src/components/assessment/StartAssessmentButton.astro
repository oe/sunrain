---
// Start Assessment Button - Astro component with minimal JS
export interface Props {
  assessmentId: string;
  buttonText: string;
  language?: string;
}

const { assessmentId, buttonText, language = 'en' } = Astro.props;
---

<button
  id={`start-btn-${assessmentId}`}
  class="btn btn-primary btn-lg w-full text-lg"
  data-testid={`start-assessment-${assessmentId}`}
  data-assessment-id={assessmentId}
  data-language={language}
>
  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
  </svg>
  {buttonText}
</button>

<script>
  // Minimal JavaScript for button functionality
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('[id^="start-btn-"]');
    
    buttons.forEach(button => {
      button.addEventListener('click', async (e) => {
        e.preventDefault();
        const assessmentId = button.getAttribute('data-assessment-id');
        const language = button.getAttribute('data-language') || 'en';
        
        if (!assessmentId) return;
        
        // Show loading state
        const originalContent = button.innerHTML;
        button.innerHTML = `
          <span class="loading loading-spinner loading-md"></span>
          ${language === 'zh' ? '加载中...' : 'Loading...'}
        `;
        (button as HTMLButtonElement).disabled = true;
        
        try {
          // Check for existing sessions
          const { assessmentEngine } = await import('@/lib/assessment/AssessmentEngine');
          const activeSessions = assessmentEngine.getActiveSessions();
          const existingSession = activeSessions.find((session: any) =>
            session.assessmentTypeId === assessmentId
          );
          
          if (existingSession) {
            // Show existing session dialog
            showExistingSessionDialog(existingSession, assessmentId, language);
          } else {
            // Navigate directly to assessment
            window.location.href = `/assessment/take/${assessmentId}/`;
          }
        } catch (error) {
          console.error('Error checking for existing sessions:', error);
          // Fallback to direct navigation
          window.location.href = `/assessment/take/${assessmentId}/`;
        } finally {
          // Restore button state
          button.innerHTML = originalContent;
          (button as HTMLButtonElement).disabled = false;
        }
      });
    });
  });
  
  function showExistingSessionDialog(session: any, assessmentId: string, language: string) {
    // Create modal element
    const modal = document.createElement('div');
    modal.className = 'modal modal-open';
    modal.innerHTML = `
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">
          ${language === 'zh' ? '未完成的评测' : 'Unfinished Assessment'}
        </h3>
        <p class="py-4">
          ${language === 'zh' ? '您有一个未完成的评测。您可以从中断的地方继续，或者重新开始。' : 'You have an unfinished assessment. You can continue from where you left off, or start over.'}
        </p>
        <div class="modal-action">
          <button class="btn btn-primary" id="continue-btn">
            ${language === 'zh' ? '继续评测' : 'Continue Assessment'}
          </button>
          <button class="btn btn-outline" id="restart-btn">
            ${language === 'zh' ? '重新开始' : 'Start Over'}
          </button>
          <button class="btn btn-ghost" id="cancel-btn">
            ${language === 'zh' ? '取消' : 'Cancel'}
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Add event listeners
    modal.querySelector('#continue-btn')?.addEventListener('click', () => {
      document.body.removeChild(modal);
      window.location.href = `/assessment/take/${assessmentId}/`;
    });
    
    modal.querySelector('#restart-btn')?.addEventListener('click', async () => {
      try {
        const { assessmentEngine } = await import('@/lib/assessment/AssessmentEngine');
        assessmentEngine.deleteSession(session.id);
        document.body.removeChild(modal);
        window.location.href = `/assessment/take/${assessmentId}/`;
      } catch (error) {
        console.error('Error restarting assessment:', error);
        document.body.removeChild(modal);
        window.location.href = `/assessment/take/${assessmentId}/`;
      }
    });
    
    modal.querySelector('#cancel-btn')?.addEventListener('click', () => {
      document.body.removeChild(modal);
    });
    
    // Close on backdrop click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });
  }
</script>
