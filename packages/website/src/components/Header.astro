---
import { createSSGTranslations } from '@/i18n/utils';
import { getSharedTranslations } from '@/locales';
import { type Language, getRelativeLocaleUrl, languages } from '@sunrain/shared';
import Dropdown from './Dropdown.astro';
import BrandName from './BrandName.astro';

export interface Props {
  lang: Language;
}

const { lang } = Astro.props;
// ä½¿ç”¨æ–°çš„SSGç¿»è¯‘ç³»ç»Ÿï¼Œä¸ä½¿ç”¨React hooks
const t = createSSGTranslations(lang);
const sharedT = getSharedTranslations(lang);

const navItems = [
  { key: 'nav.home', href: getRelativeLocaleUrl(lang, '/') },
  { key: 'nav.guide', href: getRelativeLocaleUrl(lang, '/guide/') },
  { key: 'nav.resources', href: getRelativeLocaleUrl(lang, '/resources/') },
  { key: 'nav.about', href: getRelativeLocaleUrl(lang, '/about/') }
];

const languageEmojis: Record<Language, string> = {
  en: 'ğŸ‡ºğŸ‡¸',
  zh: 'ğŸ‡¨ğŸ‡³',
  es: 'ğŸ‡ªğŸ‡¸',
  ja: 'ğŸ‡¯ğŸ‡µ',
  ko: 'ğŸ‡°ğŸ‡·',
  hi: 'ğŸ‡®ğŸ‡³',
  ar: 'ğŸ‡¸ğŸ‡¦'
};

const languageNames: Record<Language, string> = {
  en: 'English',
  zh: 'ä¸­æ–‡',
  es: 'EspaÃ±ol',
  ja: 'æ—¥æœ¬èª',
  ko: 'í•œêµ­ì–´',
  hi: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€',
  ar: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'
};

const getLocalizedPath = (locale: Language) => {
  const path = Astro.url.pathname.replace(`/${lang}`, '');
  return getRelativeLocaleUrl(locale, path);
};

const themeOptions = [
  { key: 'system', label: sharedT.theme.system, icon: 'M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z' },
  { key: 'light', label: sharedT.theme.light, icon: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' },
  { key: 'dark', label: sharedT.theme.dark, icon: 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z' }
];

// Get current theme from localStorage (this will be handled by client-side JS)
// For server-side rendering, we'll use a default value and update it client-side
const currentTheme = 'system'; // Default value, will be updated by JS
---

<header
  class="fixed top-0 left-0 right-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-700 transition-colors duration-300"
>
  <nav
    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"
    role="navigation"
    aria-label="Main navigation"
  >
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <div class="flex items-center">
        <a
          href={getRelativeLocaleUrl(lang, '/')}
          class="flex items-center space-x-1 rtl:space-x-reverse group focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900 rounded-md p-1 -m-1"
          aria-label="Sunrain.me - Home"
        >
          <div class="relative" aria-hidden="true">
            <img 
              src="/logo.png" 
              alt="Sunrain Logo" 
              class="w-8 h-8 object-contain"
            />
          </div>
          <BrandName
            class="text-xl"
          />
        </a>
      </div>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center space-x-1 rtl:space-x-reverse" role="menubar">
        {
          navItems.map(({ key, href }) => (
            <a
              href={href}
              class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 text-sm font-medium transition-colors duration-200 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
              role="menuitem"
            >
              {t(key)}
            </a>
          ))
        }
      </div>

      <!-- Right side controls -->
      <div class="flex items-center space-x-2 rtl:space-x-reverse">
        <!-- Language Switcher -->
        <Dropdown
          id="language-switcher"
          buttonId="language-button"
          dropdownId="language-dropdown"
          buttonLabel={`Change language. Current language: ${languageNames[lang]}`}
          buttonTitle={`Current language: ${languageNames[lang]}`}
          buttonIcon="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"
          buttonText={lang.toUpperCase()}
          options={Object.keys(languages).map((code) => {
            const languageCode = code as Language;
            return {
              key: code,
              label: languageNames[languageCode],
              icon: languageEmojis[languageCode],
              href: getLocalizedPath(languageCode),
              isSelected: code === lang
            };
          })}
          dropdownLabel="Language options"
        />

        <!-- Theme Switcher -->
        <Dropdown
          id="theme-switcher"
          buttonId="theme-button"
          dropdownId="theme-dropdown"
          buttonLabel={sharedT.theme.toggle}
          buttonIcon="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
          buttonText="SYS"
          options={themeOptions.map((option) => ({
            key: option.key,
            label: option.label,
            icon: option.icon,
            dataValue: option.key,
            isSelected: option.key === currentTheme
          }))}
          dropdownLabel={sharedT.theme.toggle}
        />

        <!-- Mobile menu button -->
        <button
          id="mobile-menu-button"
          class="md:hidden p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
          aria-label="Toggle mobile menu"
          aria-expanded="false"
          aria-controls="mobile-menu"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation -->
    <div
      id="mobile-menu"
      class="md:hidden hidden border-t border-gray-200 dark:border-gray-700 py-4 bg-white dark:bg-gray-900 transition-all duration-300"
      role="menu"
      aria-label="Mobile navigation menu"
    >
      <div class="space-y-1">
        {
          navItems.map(({ key, href }) => (
            <a
              href={href}
              class="block text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-50 dark:hover:bg-gray-800 px-4 py-3 text-base font-medium transition-all duration-200 rounded-md mx-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900"
              role="menuitem"
            >
              {t(key)}
            </a>
          ))
        }
      </div>
    </div>
  </nav>
</header>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Enhanced scroll effect for header with dark mode support
    const header = document.querySelector('header');
    let isScrolled = false;

    window.addEventListener('scroll', () => {
      const currentScrollY = window.scrollY;
      const shouldBeScrolled = currentScrollY > 50;

      if (shouldBeScrolled !== isScrolled) {
        isScrolled = shouldBeScrolled;
        
        if (isScrolled) {
          header?.classList.add('shadow-sm', 'bg-white/100', 'dark:bg-gray-900/100');
          header?.classList.remove('bg-white/95', 'dark:bg-gray-900/95');
        } else {
          header?.classList.remove('shadow-sm', 'bg-white/100', 'dark:bg-gray-900/100');
          header?.classList.add('bg-white/95', 'dark:bg-gray-900/95');
        }
      }
    });

    // Mobile menu toggle
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    
    if (mobileMenuButton && mobileMenu) {
      mobileMenuButton.addEventListener('click', () => {
        const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
        mobileMenuButton.setAttribute('aria-expanded', (!isExpanded).toString());
        mobileMenu.classList.toggle('hidden');
      });
    }

    // Theme switching
    const themeButtons = document.querySelectorAll('#theme-dropdown [data-value]');
    const themeButton = document.getElementById('theme-button');
    const themeButtonText = themeButton?.querySelector('span[aria-hidden="true"]');
    
    const applyTheme = (selectedTheme: string) => {
      const html = document.documentElement;
      html.classList.remove('dark');
      html.removeAttribute('data-theme');

      if (selectedTheme === 'dark') {
        html.classList.add('dark');
        html.setAttribute('data-theme', 'dark');
      } else if (selectedTheme === 'light') {
        html.setAttribute('data-theme', 'light');
      } else { // system
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (prefersDark) {
          html.classList.add('dark');
          html.setAttribute('data-theme', 'dark');
        } else {
          html.setAttribute('data-theme', 'light');
        }
      }

      localStorage.setItem('theme', selectedTheme);
      
      // Update theme button text
      if (themeButtonText) {
        themeButtonText.textContent = selectedTheme === 'system' ? 'SYS' : selectedTheme === 'light' ? 'LGT' : 'DRK';
      }
      
      // Update theme dropdown selection
      const themeButtons = document.querySelectorAll('#theme-dropdown [data-value]');
      themeButtons.forEach(button => {
        const isSelected = button.getAttribute('data-value') === selectedTheme;
        button.setAttribute('data-selected', isSelected.toString());
        
        // Update visual selection state
        if (isSelected) {
          button.classList.add('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-medium');
          button.classList.remove('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-white');
          
          // Show checkmark
          const checkmark = button.querySelector('svg[aria-label="Current selection"]');
          if (checkmark) {
            checkmark.classList.remove('hidden');
          }
        } else {
          button.classList.remove('bg-blue-50', 'dark:bg-blue-900/30', 'text-blue-600', 'dark:text-blue-400', 'font-medium');
          button.classList.add('text-gray-700', 'dark:text-gray-300', 'hover:bg-gray-50', 'dark:hover:bg-gray-700', 'hover:text-gray-900', 'dark:hover:text-white');
          
          // Hide checkmark
          const checkmark = button.querySelector('svg[aria-label="Current selection"]');
          if (checkmark) {
            checkmark.classList.add('hidden');
          }
        }
      });
    };

    // Initialize theme
    const savedTheme = localStorage.getItem('theme') || 'system';
    applyTheme(savedTheme);

    // Theme button event listeners
    themeButtons.forEach(button => {
      button.addEventListener('click', () => {
        const theme = button.getAttribute('data-value');
        if (theme) {
          applyTheme(theme);
        }
      });
    });

    // Keyboard navigation support for desktop menu
    const desktopMenuItems = document.querySelectorAll(
      '[role="menubar"] [role="menuitem"]'
    );
    desktopMenuItems.forEach((item, index) => {
      item.addEventListener('keydown', (event) => {
        const key = (event as KeyboardEvent).key;

        if (key === 'ArrowRight' || key === 'ArrowDown') {
          event.preventDefault();
          const nextIndex = (index + 1) % desktopMenuItems.length;
          (desktopMenuItems[nextIndex] as HTMLElement).focus();
        } else if (key === 'ArrowLeft' || key === 'ArrowUp') {
          event.preventDefault();
          const prevIndex =
            (index - 1 + desktopMenuItems.length) % desktopMenuItems.length;
          (desktopMenuItems[prevIndex] as HTMLElement).focus();
        }
      });
    });
  });
</script>

