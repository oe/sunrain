---
// Assessment trends and visualization page
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getLocale } from 'astro-i18n-aut';
import { getAssessmentTranslations } from '@/locales/assessment';
import type { Language } from '@sunrain/shared';

const currentLang = getLocale(Astro.url) as Language;
const t = getAssessmentTranslations(currentLang);
---

<BaseLayout title={t.trends.title}>
  <main class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{t.trends.title}</h1>
        <p class="text-gray-600 dark:text-gray-300">{t.trends.subtitle}</p>
      </div>

      <!-- Loading State -->
      <div id="trends-loading" class="text-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <p class="text-gray-600 dark:text-gray-300">{t.trends.loading}</p>
      </div>

      <!-- Trends Interface -->
      <div id="trends-interface" class="hidden">
        <!-- Time Range Selector -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6 mb-8">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">{t.trends.timeRange.title}</h2>
            <div class="flex space-x-2">
              <button class="time-range-btn px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-range="30">
                最近30天
              </button>
              <button class="time-range-btn px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-range="90">
                最近3个月
              </button>
              <button class="time-range-btn px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors active" data-range="365">
                最近一年
              </button>
              <button class="time-range-btn px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors" data-range="all">
                全部时间
              </button>
            </div>
          </div>
        </div>

        <!-- Trend Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <!-- Overall Trend Chart -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">整体趋势</h3>
            <div id="overall-trend-chart" class="h-64">
              <!-- Chart will be rendered here -->
            </div>
          </div>

          <!-- Assessment Frequency -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">评测频率</h3>
            <div id="frequency-chart" class="h-64">
              <!-- Chart will be rendered here -->
            </div>
          </div>

          <!-- Risk Level Trends -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">风险等级变化</h3>
            <div id="risk-trend-chart" class="h-64">
              <!-- Chart will be rendered here -->
            </div>
          </div>

          <!-- Category Performance -->
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">各维度表现</h3>
            <div id="category-performance-chart" class="h-64">
              <!-- Chart will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Insights and Recommendations -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6 mb-8">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">趋势洞察</h3>
          <div id="insights-container" class="space-y-4">
            <!-- Insights will be dynamically generated -->
          </div>
        </div>

        <!-- Detailed Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center">
              <div class="p-2 bg-blue-100 dark:bg-blue-900 rounded-lg">
                <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 001.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">改善趋势</p>
                <p id="improvement-trend" class="text-2xl font-semibold text-gray-900 dark:text-white">-</p>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center">
              <div class="p-2 bg-green-100 dark:bg-green-900 rounded-lg">
                <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">稳定维度</p>
                <p id="stable-dimensions" class="text-2xl font-semibold text-gray-900 dark:text-white">-</p>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center">
              <div class="p-2 bg-yellow-100 dark:bg-yellow-900 rounded-lg">
                <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <div class="ml-4">
                <p class="text-sm font-medium text-gray-600 dark:text-gray-400">需要关注</p>
                <p id="attention-needed" class="text-2xl font-semibold text-gray-900 dark:text-white">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Export and Actions -->
        <div class="flex justify-center space-x-4">
          <button id="export-trends-btn" class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            导出趋势报告
          </button>
          <a href="/assessment/" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            进行新评测
          </a>
        </div>
      </div>

      <!-- No Data State -->
      <div id="no-data-state" class="hidden text-center py-12">
        <svg class="w-16 h-16 text-gray-400 dark:text-gray-600 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 0l-2 2a1 1 0 001.414 1.414L8 10.414l1.293 1.293a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">暂无趋势数据</h2>
        <p class="text-gray-600 dark:text-gray-300 mb-6">您需要完成至少2次评测才能查看趋势分析</p>
        <a href="/assessment/" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
          开始评测
          <svg class="ml-2 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </a>
      </div>
    </div>
  </main>

  <script>
    import { resultsAnalyzer } from '@/lib/assessment/ResultsAnalyzer';
    import { questionBankManager } from '@/lib/assessment/QuestionBankManager';

    class TrendsAnalysis {
      currentRange: number | null;
      results: any[];

      constructor() {
        this.currentRange = 365; // Default to 1 year
        this.results = [];
        this.initializeInterface();
      }

      async initializeInterface() {
        try {
          // Load all results
          this.results = resultsAnalyzer.getAllResults();

          // Hide loading
          document.getElementById('trends-loading').classList.add('hidden');

          if (this.results.length < 2) {
            document.getElementById('no-data-state').classList.remove('hidden');
            return;
          }

          // Show interface and render trends
          document.getElementById('trends-interface').classList.remove('hidden');
          this.setupEventListeners();
          this.renderTrends();

        } catch (error) {
          console.error('Failed to load trends:', error);
          this.showError();
        }
      }

      setupEventListeners() {
        // Time range buttons
        document.querySelectorAll('.time-range-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;

            // Update active state
            document.querySelectorAll('.time-range-btn').forEach(b => b.classList.remove('active'));
            target.classList.add('active');

            // Update range and re-render
            this.currentRange = target.dataset.range === 'all' ? null : parseInt(target.dataset.range || '365');
            this.renderTrends();
          });
        });

        // Export button
        document.getElementById('export-trends-btn').addEventListener('click', () => {
          this.exportTrendsReport();
        });
      }

      renderTrends() {
        const filteredResults = this.getFilteredResults();

        this.renderOverallTrend(filteredResults);
        this.renderFrequencyChart(filteredResults);
        this.renderRiskTrendChart(filteredResults);
        this.renderCategoryPerformance(filteredResults);
        this.generateInsights(filteredResults);
        this.updateStatistics(filteredResults);
      }

      getFilteredResults() {
        if (!this.currentRange) return this.results;

        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - this.currentRange);

        return this.results.filter(result =>
          new Date(result.completedAt) >= cutoffDate
        );
      }

      renderOverallTrend(results) {
        const container = document.getElementById('overall-trend-chart');
        container.innerHTML = '';

        if (results.length === 0) {
          container.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 py-8">暂无数据</p>';
          return;
        }

        // Group results by month
        const monthlyData = this.groupResultsByMonth(results);

        // Simple line chart representation
        const chartDiv = document.createElement('div');
        chartDiv.className = 'space-y-2';

        Object.entries(monthlyData).forEach(([month, monthResults]) => {
          const avgScore = this.calculateAverageScore(monthResults);
          const percentage = Math.min(avgScore * 10, 100); // Assuming max score of 10

          const barDiv = document.createElement('div');
          barDiv.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm text-gray-600 dark:text-gray-300">${month}</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${avgScore.toFixed(1)}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="h-2 rounded-full bg-blue-600" style="width: ${percentage}%"></div>
            </div>
          `;
          chartDiv.appendChild(barDiv);
        });

        container.appendChild(chartDiv);
      }

      renderFrequencyChart(results) {
        const container = document.getElementById('frequency-chart');
        container.innerHTML = '';

        const monthlyFrequency = this.getMonthlyFrequency(results);

        const chartDiv = document.createElement('div');
        chartDiv.className = 'space-y-2';

        Object.entries(monthlyFrequency).forEach(([month, count]) => {
          const maxCount = Math.max(...Object.values(monthlyFrequency) as number[]);
          const percentage = ((count as number) / maxCount) * 100;

          const barDiv = document.createElement('div');
          barDiv.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm text-gray-600 dark:text-gray-300">${month}</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${count} 次</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="h-2 rounded-full bg-green-600" style="width: ${percentage}%"></div>
            </div>
          `;
          chartDiv.appendChild(barDiv);
        });

        container.appendChild(chartDiv);
      }

      renderRiskTrendChart(results) {
        const container = document.getElementById('risk-trend-chart');
        container.innerHTML = '';

        const riskTrends = this.getRiskTrends(results);

        const chartDiv = document.createElement('div');
        chartDiv.className = 'space-y-4';

        ['low', 'medium', 'high'].forEach(riskLevel => {
          const data = riskTrends[riskLevel] || [];
          const avgPercentage = data.length > 0 ?
            data.reduce((sum, val) => sum + val, 0) / data.length : 0;

          const color = riskLevel === 'low' ? 'green' :
                       riskLevel === 'medium' ? 'yellow' : 'red';

          const barDiv = document.createElement('div');
          barDiv.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm text-gray-600 dark:text-gray-300">
                ${riskLevel === 'low' ? '低风险' : riskLevel === 'medium' ? '中风险' : '高风险'}
              </span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${avgPercentage.toFixed(1)}%</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="h-2 rounded-full bg-${color}-600" style="width: ${avgPercentage}%"></div>
            </div>
          `;
          chartDiv.appendChild(barDiv);
        });

        container.appendChild(chartDiv);
      }

      renderCategoryPerformance(results) {
        const container = document.getElementById('category-performance-chart');
        container.innerHTML = '';

        const categoryPerformance = this.getCategoryPerformance(results);

        const chartDiv = document.createElement('div');
        chartDiv.className = 'space-y-2';

        Object.entries(categoryPerformance).forEach(([category, avgScore]) => {
          const percentage = Math.min((avgScore as number) * 10, 100);
          const categoryName = category === 'mental_health' ? '心理健康' :
                              category === 'personality' ? '性格特质' :
                              category === 'stress' ? '压力管理' :
                              category === 'mood' ? '情绪状态' : category;

          const barDiv = document.createElement('div');
          barDiv.innerHTML = `
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm text-gray-600 dark:text-gray-300">${categoryName}</span>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${(avgScore as number).toFixed(1)}</span>
            </div>
            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
              <div class="h-2 rounded-full bg-purple-600" style="width: ${percentage}%"></div>
            </div>
          `;
          chartDiv.appendChild(barDiv);
        });

        container.appendChild(chartDiv);
      }

      generateInsights(results) {
        const container = document.getElementById('insights-container');
        container.innerHTML = '';

        const insights = this.analyzeInsights(results);

        insights.forEach(insight => {
          const insightDiv = document.createElement('div');
          insightDiv.className = `p-4 rounded-lg border ${insight.type === 'positive' ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' :
                                                        insight.type === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800' :
                                                        'bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800'}`;

          insightDiv.innerHTML = `
            <div class="flex items-start">
              <svg class="w-5 h-5 ${insight.type === 'positive' ? 'text-green-600 dark:text-green-400' :
                                   insight.type === 'warning' ? 'text-yellow-600 dark:text-yellow-400' :
                                   'text-blue-600 dark:text-blue-400'} mr-3 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <h4 class="font-medium ${insight.type === 'positive' ? 'text-green-800 dark:text-green-200' :
                                       insight.type === 'warning' ? 'text-yellow-800 dark:text-yellow-200' :
                                       'text-blue-800 dark:text-blue-200'}">${insight.title}</h4>
                <p class="text-sm ${insight.type === 'positive' ? 'text-green-700 dark:text-green-300' :
                                   insight.type === 'warning' ? 'text-yellow-700 dark:text-yellow-300' :
                                   'text-blue-700 dark:text-blue-300'} mt-1">${insight.message}</p>
              </div>
            </div>
          `;

          container.appendChild(insightDiv);
        });
      }

      updateStatistics(results) {
        const trends = this.calculateTrendStatistics(results);

        document.getElementById('improvement-trend').textContent = trends.improvement;
        document.getElementById('stable-dimensions').textContent = trends.stable;
        document.getElementById('attention-needed').textContent = trends.attention;
      }

      // Helper methods for data processing
      groupResultsByMonth(results) {
        const grouped = {};
        results.forEach(result => {
          const date = new Date(result.completedAt);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!grouped[monthKey]) grouped[monthKey] = [];
          grouped[monthKey].push(result);
        });
        return grouped;
      }

      calculateAverageScore(results) {
        if (results.length === 0) return 0;
        const totalScore = results.reduce((sum, result) => {
          const scores = Object.values(result.scores);
          const avgScore = (scores as any[]).reduce((s: number, score: any) => s + score.value, 0) / scores.length;
          return sum + avgScore;
        }, 0);
        return totalScore / results.length;
      }

      getMonthlyFrequency(results) {
        const frequency = {};
        results.forEach(result => {
          const date = new Date(result.completedAt);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          frequency[monthKey] = (frequency[monthKey] || 0) + 1;
        });
        return frequency;
      }

      getRiskTrends(results) {
        const trends = { low: [], medium: [], high: [] };
        const monthlyData = this.groupResultsByMonth(results);

        Object.values(monthlyData).forEach(monthResults => {
          const riskCounts = { low: 0, medium: 0, high: 0 };
          (monthResults as any[]).forEach(result => {
            if (result.riskLevel) {
              riskCounts[result.riskLevel]++;
            }
          });

          const total = (monthResults as any[]).length;
          if (total > 0) {
            trends.low.push((riskCounts.low / total) * 100);
            trends.medium.push((riskCounts.medium / total) * 100);
            trends.high.push((riskCounts.high / total) * 100);
          }
        });

        return trends;
      }

      getCategoryPerformance(results) {
        const performance = {};
        results.forEach(result => {
          const assessmentType = questionBankManager.getAssessmentType(result.assessmentTypeId);
          if (assessmentType) {
            const category = assessmentType.category;
            if (!performance[category]) performance[category] = [];

            const scores = Object.values(result.scores);
            const avgScore = (scores as any[]).reduce((sum: number, score: any) => sum + score.value, 0) / scores.length;
            performance[category].push(avgScore);
          }
        });

        // Calculate averages
        Object.keys(performance).forEach(category => {
          const scores = performance[category];
          performance[category] = scores.reduce((sum, score) => sum + score, 0) / scores.length;
        });

        return performance;
      }

      analyzeInsights(results) {
        const insights = [];

        if (results.length >= 3) {
          const recent = results.slice(-3);
          const older = results.slice(0, -3);

          const recentAvg = this.calculateAverageScore(recent);
          const olderAvg = this.calculateAverageScore(older);

          if (recentAvg > olderAvg * 1.1) {
            insights.push({
              type: 'positive',
              title: '积极趋势',
              message: '您的心理健康状态在最近的评测中显示出改善趋势，继续保持！'
            });
          } else if (recentAvg < olderAvg * 0.9) {
            insights.push({
              type: 'warning',
              title: '需要关注',
              message: '最近的评测结果显示有所下降，建议关注心理健康状态并考虑寻求支持。'
            });
          } else {
            insights.push({
              type: 'info',
              title: '保持稳定',
              message: '您的心理健康状态保持相对稳定，继续维持良好的生活习惯。'
            });
          }
        }

        // Assessment frequency insight
        const daysSinceFirst = (Date.now() - new Date(results[0].completedAt).getTime()) / (1000 * 60 * 60 * 24);
        const frequency = results.length / (daysSinceFirst / 30); // assessments per month

        if (frequency > 2) {
          insights.push({
            type: 'positive',
            title: '评测频率良好',
            message: '您定期进行心理健康评测，这有助于及时了解自己的状态变化。'
          });
        } else if (frequency < 0.5) {
          insights.push({
            type: 'info',
            title: '建议增加评测频率',
            message: '定期评测有助于更好地了解心理健康趋势，建议每月至少进行一次评测。'
          });
        }

        return insights;
      }

      calculateTrendStatistics(results) {
        if (results.length < 2) {
          return { improvement: '-', stable: '-', attention: '-' };
        }

        const recent = results.slice(-Math.ceil(results.length / 2));
        const older = results.slice(0, Math.floor(results.length / 2));

        let improving = 0, stable = 0, declining = 0;

        // Compare categories
        const categories = ['mental_health', 'personality', 'stress', 'mood'];
        categories.forEach(category => {
          const recentCat = recent.filter(r => {
            const type = questionBankManager.getAssessmentType(r.assessmentTypeId);
            return type && type.category === category;
          });
          const olderCat = older.filter(r => {
            const type = questionBankManager.getAssessmentType(r.assessmentTypeId);
            return type && type.category === category;
          });

          if (recentCat.length > 0 && olderCat.length > 0) {
            const recentAvg = this.calculateAverageScore(recentCat);
            const olderAvg = this.calculateAverageScore(olderCat);

            if (recentAvg > olderAvg * 1.05) improving++;
            else if (recentAvg < olderAvg * 0.95) declining++;
            else stable++;
          }
        });

        return {
          improvement: improving > 0 ? `${improving} 个维度` : '暂无',
          stable: stable > 0 ? `${stable} 个维度` : '暂无',
          attention: declining > 0 ? `${declining} 个维度` : '暂无'
        };
      }

      exportTrendsReport() {
        try {
          const filteredResults = this.getFilteredResults();
          const report = {
            generatedAt: new Date().toISOString(),
            timeRange: this.currentRange ? `${this.currentRange} days` : 'all time',
            totalAssessments: filteredResults.length,
            trends: {
              overall: this.calculateAverageScore(filteredResults),
              categoryPerformance: this.getCategoryPerformance(filteredResults),
              riskTrends: this.getRiskTrends(filteredResults),
              insights: this.analyzeInsights(filteredResults)
            },
            rawData: filteredResults
          };

          const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);

          const a = document.createElement('a');
          a.href = url;
          a.download = `mental-health-trends-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          this.showMessage('趋势报告导出成功', 'success');
        } catch (error) {
          console.error('Export failed:', error);
          this.showMessage('导出失败，请重试', 'error');
        }
      }

      showMessage(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 ${
          type === 'success' ? 'bg-green-600 text-white' :
          type === 'error' ? 'bg-red-600 text-white' :
          'bg-blue-600 text-white'
        }`;
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 3000);
      }

      showError() {
        document.getElementById('trends-loading').classList.add('hidden');

        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-center py-12';
        errorDiv.innerHTML = `
          <svg class="w-16 h-16 text-red-400 dark:text-red-600 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">加载失败</h2>
          <p class="text-gray-600 dark:text-gray-300 mb-6">无法加载趋势数据，请刷新页面重试</p>
          <button onclick="window.location.reload()" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
            刷新页面
          </button>
        `;

        document.querySelector('main .max-w-6xl').appendChild(errorDiv);
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new TrendsAnalysis();
    });
  </script>
</BaseLayout>
