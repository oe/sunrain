name: Content Update Automation

on:
  # å®šæ—¶ä»»åŠ¡ - æ¯å‘¨ä¸€ã€ä¸‰ã€äº”çš„åˆå¤œè¿è¡Œ
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€åˆå¤œ - ä¹¦ç±æ›´æ–°
    - cron: '0 0 * * 3'  # æ¯å‘¨ä¸‰åˆå¤œ - éŸ³ä¹æ›´æ–°  
    - cron: '0 0 * * 5'  # æ¯å‘¨äº”åˆå¤œ - ç”µå½±æ›´æ–°
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      content_type:
        description: 'Type of content to update'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - books
          - music
          - movies
      dry_run:
        description: 'Run in dry-run mode (no file changes)'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  update-content:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: |
          cd scripts
          pnpm install

      - name: Determine content type
        id: content-type
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # æ ¹æ®cronæ—¶é—´ç¡®å®šå†…å®¹ç±»å‹
            case "${{ github.event.schedule }}" in
              "0 0 * * 1") echo "type=books" >> $GITHUB_OUTPUT ;;
              "0 0 * * 3") echo "type=music" >> $GITHUB_OUTPUT ;;
              "0 0 * * 5") echo "type=movies" >> $GITHUB_OUTPUT ;;
              *) echo "type=all" >> $GITHUB_OUTPUT ;;
            esac
          else
            echo "type=${{ github.event.inputs.content_type || 'all' }}" >> $GITHUB_OUTPUT
          fi
          
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "dry_run=--dry-run" >> $GITHUB_OUTPUT
          else
            echo "dry_run=" >> $GITHUB_OUTPUT
          fi

      - name: Create environment file
        run: |
          cd scripts
          cat > .env << EOF
          GOODREADS_API_KEY=${{ secrets.GOODREADS_API_KEY }}
          SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET }}
          TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}
          GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY }}
          NODE_ENV=production
          EOF

      - name: Update content
        id: update
        run: |
          cd scripts
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "content_type=${{ steps.content-type.outputs.type }}" >> $GITHUB_OUTPUT
          
          # è¿è¡Œå†…å®¹æ›´æ–°
          if npx tsx content-fetcher/cli.ts --type ${{ steps.content-type.outputs.type }} ${{ steps.content-type.outputs.dry_run }} --verbose; then
            echo "Content update completed successfully"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ï¼ˆä»…åœ¨édry-runæ¨¡å¼ä¸‹ï¼‰
            if [ "${{ steps.content-type.outputs.dry_run }}" = "" ]; then
              if git diff --quiet HEAD -- ../src/content/resources/; then
                echo "No changes detected"
              else
                echo "changes=true" >> $GITHUB_OUTPUT
                echo "Changes detected in resource files"
              fi
            fi
          else
            echo "Content update failed"
            exit 1
          fi

      - name: Commit and create PR
        if: steps.update.outputs.changes == 'true'
        run: |
          # é…ç½®git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # åˆ›å»ºæ–°åˆ†æ”¯
          BRANCH_NAME="content-update-${{ steps.update.outputs.content_type }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # æ·»åŠ å˜æ›´
          git add src/content/resources/
          
          # æäº¤å˜æ›´
          COMMIT_MSG="ğŸ¤– Auto-update ${{ steps.update.outputs.content_type }} content resources
          
          - Updated via GitHub Actions workflow
          - Content type: ${{ steps.update.outputs.content_type }}
          - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          This is an automated update of mental health resources."
          
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€åˆ†æ”¯
          git push origin $BRANCH_NAME
          
          # åˆ›å»ºPull Request
          gh pr create \
            --title "ğŸ¤– Auto-update ${{ steps.update.outputs.content_type }} content resources" \
            --body "## Automated Content Update

          This PR contains automatically updated mental health resources.

          **Content Type:** ${{ steps.update.outputs.content_type }}
          **Update Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow:** ${{ github.workflow }}

          ### Changes
          - Updated resource files in \`src/content/resources/\`
          - Content fetched from configured APIs
          - All content validated for mental health relevance

          ### Review Notes
          - Please review the updated content for accuracy
          - Verify that all resources are appropriate for mental health context
          - Check for any formatting or data quality issues

          This PR will be automatically merged if all checks pass and no manual review is required." \
            --head $BRANCH_NAME \
            --base main \
            --label "automated,content-update"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR (optional)
        if: steps.update.outputs.changes == 'true' && github.event.inputs.content_type != 'all'
        run: |
          # ç­‰å¾…PRåˆ›å»ºå®Œæˆ
          sleep 10
          
          # è·å–æœ€æ–°çš„PR
          PR_NUMBER=$(gh pr list --head content-update-${{ steps.update.outputs.content_type }}-* --json number --jq '.[0].number')
          
          if [ ! -z "$PR_NUMBER" ]; then
            echo "Found PR #$PR_NUMBER, attempting auto-merge..."
            
            # å¯ç”¨è‡ªåŠ¨åˆå¹¶ï¼ˆéœ€è¦é€šè¿‡æ‰€æœ‰æ£€æŸ¥ï¼‰
            gh pr merge $PR_NUMBER --auto --squash --delete-branch
            
            echo "Auto-merge enabled for PR #$PR_NUMBER"
          else
            echo "No PR found for auto-merge"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "Content update workflow failed!"
          
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚å‘é€é‚®ä»¶æˆ–Slackæ¶ˆæ¯
          # ç¤ºä¾‹ï¼šå‘é€åˆ°webhook
          if [ ! -z "${{ secrets.WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "ğŸš¨ Content Update Failed",
                "attachments": [{
                  "color": "danger",
                  "fields": [{
                    "title": "Workflow",
                    "value": "${{ github.workflow }}",
                    "short": true
                  }, {
                    "title": "Content Type", 
                    "value": "${{ steps.content-type.outputs.type }}",
                    "short": true
                  }, {
                    "title": "Repository",
                    "value": "${{ github.repository }}",
                    "short": true
                  }, {
                    "title": "Run URL",
                    "value": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                    "short": false
                  }]
                }]
              }'
          fi

  # æ¸…ç†æ—§çš„åˆ†æ”¯å’ŒPRï¼ˆå¯é€‰ï¼‰
  cleanup:
    runs-on: ubuntu-latest
    if: always()
    needs: update-content
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Clean up old branches
        run: |
          # åˆ é™¤è¶…è¿‡7å¤©çš„content-updateåˆ†æ”¯
          git for-each-ref --format='%(refname:short) %(committerdate)' refs/remotes/origin/content-update-* | \
          while read branch date; do
            if [[ $(date -d "$date" +%s) -lt $(date -d "7 days ago" +%s) ]]; then
              branch_name=${branch#origin/}
              echo "Deleting old branch: $branch_name"
              git push origin --delete $branch_name || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}