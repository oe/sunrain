name: Manual Content Update

on:
  workflow_dispatch:
    inputs:
      content_type:
        description: 'Select content type to update'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - books
          - music
          - movies
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: false
        type: boolean
      create_pr:
        description: 'Create Pull Request for changes'
        required: false
        default: true
        type: boolean
      auto_merge:
        description: 'Auto-merge PR if all checks pass'
        required: false
        default: false
        type: boolean

jobs:
  manual-update:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '8'

      - name: Install dependencies
        run: |
          cd scripts
          pnpm install

      - name: Create environment file
        run: |
          cd scripts
          cat > .env << EOF
          GOODREADS_API_KEY=${{ secrets.GOODREADS_API_KEY }}
          SPOTIFY_CLIENT_ID=${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET=${{ secrets.SPOTIFY_CLIENT_SECRET }}
          TMDB_API_KEY=${{ secrets.TMDB_API_KEY }}
          GOOGLE_BOOKS_API_KEY=${{ secrets.GOOGLE_BOOKS_API_KEY }}
          NODE_ENV=production
          DEBUG=true
          EOF

      - name: Run content update
        id: update
        run: |
          cd scripts
          
          echo "Starting manual content update..."
          echo "Content type: ${{ github.event.inputs.content_type }}"
          echo "Force update: ${{ github.event.inputs.force_update }}"
          
          # è¿è¡Œå†…å®¹æ›´æ–°
          if npx tsx content-fetcher/cli.ts --type ${{ github.event.inputs.content_type }} --verbose; then
            echo "âœ… Content update completed successfully"
            echo "success=true" >> $GITHUB_OUTPUT
            
            # æ£€æŸ¥å˜æ›´
            if git diff --quiet HEAD -- ../src/content/resources/; then
              echo "â„¹ï¸ No changes detected in resource files"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "ðŸ“ Changes detected in resource files"
              echo "has_changes=true" >> $GITHUB_OUTPUT
              
              # æ˜¾ç¤ºå˜æ›´æ‘˜è¦
              echo "## Changes Summary" >> $GITHUB_STEP_SUMMARY
              git diff --stat HEAD -- ../src/content/resources/ >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Content update failed"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Display update results
        run: |
          echo "## Update Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Content Type**: ${{ github.event.inputs.content_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Success**: ${{ steps.update.outputs.success }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Has Changes**: ${{ steps.update.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force Update**: ${{ github.event.inputs.force_update }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Create PR**: ${{ github.event.inputs.create_pr }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.update.outputs.has_changes }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Modified Files" >> $GITHUB_STEP_SUMMARY
            git diff --name-only HEAD -- src/content/resources/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit changes directly to main
        if: |
          steps.update.outputs.success == 'true' && 
          (steps.update.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true') &&
          github.event.inputs.create_pr == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action (Manual)"
          
          git add src/content/resources/
          
          COMMIT_MSG="ðŸ”§ Manual content update: ${{ github.event.inputs.content_type }}
          
          - Manually triggered content update
          - Content type: ${{ github.event.inputs.content_type }}
          - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Triggered by: ${{ github.actor }}
          
          Updated mental health resources via manual workflow."
          
          git commit -m "$COMMIT_MSG"
          git push origin main
          
          echo "âœ… Changes committed directly to main branch" >> $GITHUB_STEP_SUMMARY

      - name: Create Pull Request
        if: |
          steps.update.outputs.success == 'true' && 
          (steps.update.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true') &&
          github.event.inputs.create_pr == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action (Manual)"
          
          # åˆ›å»ºæ–°åˆ†æ”¯
          BRANCH_NAME="manual-content-update-${{ github.event.inputs.content_type }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          
          # æ·»åŠ å˜æ›´
          git add src/content/resources/
          
          # æäº¤å˜æ›´
          COMMIT_MSG="ðŸ”§ Manual content update: ${{ github.event.inputs.content_type }}
          
          - Manually triggered by: ${{ github.actor }}
          - Content type: ${{ github.event.inputs.content_type }}
          - Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Force update: ${{ github.event.inputs.force_update }}
          
          This is a manual update of mental health resources."
          
          git commit -m "$COMMIT_MSG"
          git push origin $BRANCH_NAME
          
          # åˆ›å»ºPR
          PR_BODY="## Manual Content Update

          This PR contains manually triggered updates to mental health resources.

          **Triggered by:** @${{ github.actor }}
          **Content Type:** ${{ github.event.inputs.content_type }}
          **Update Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Force Update:** ${{ github.event.inputs.force_update }}

          ### Configuration
          - Auto-merge: ${{ github.event.inputs.auto_merge }}
          - Has changes: ${{ steps.update.outputs.has_changes }}

          ### Review Checklist
          - [ ] Content accuracy verified
          - [ ] Mental health relevance confirmed
          - [ ] No inappropriate content
          - [ ] Formatting is correct
          - [ ] Links are functional

          Please review the changes before merging."

          gh pr create \
            --title "ðŸ”§ Manual content update: ${{ github.event.inputs.content_type }}" \
            --body "$PR_BODY" \
            --head $BRANCH_NAME \
            --base main \
            --label "manual,content-update"
          
          echo "ðŸ“‹ Pull Request created successfully" >> $GITHUB_STEP_SUMMARY
          echo "Branch: $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR
        if: |
          steps.update.outputs.success == 'true' && 
          github.event.inputs.create_pr == 'true' &&
          github.event.inputs.auto_merge == 'true'
        run: |
          sleep 5  # ç­‰å¾…PRåˆ›å»ºå®Œæˆ
          
          # èŽ·å–æœ€æ–°çš„PR
          PR_NUMBER=$(gh pr list --head manual-content-update-${{ github.event.inputs.content_type }}-* --json number --jq '.[0].number')
          
          if [ ! -z "$PR_NUMBER" ]; then
            echo "ðŸ”„ Enabling auto-merge for PR #$PR_NUMBER..."
            gh pr merge $PR_NUMBER --auto --squash --delete-branch
            echo "âœ… Auto-merge enabled for PR #$PR_NUMBER" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No PR found for auto-merge" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow completed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.update.outputs.success }}" = "true" ]; then
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
          fi